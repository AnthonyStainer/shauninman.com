<!DOCTYPE html>
<html>
<head>
<title>A Nice Clouds Record</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
<style>
body {
	background-color: black;
	margin: 0;
	padding: 0;
}

#record {
	margin: 32px auto;
	width: 400px;
}

img,canvas {
	image-rendering: -webkit-optimize-contrast;
	image-rendering: -moz-crisp-edges;
	-ms-interpolation-mode: nearest-neighbor;
	display: block;
}
</style>
</head>
<body>
<div id=record><b class=playdate><i></i></b></div>
<script>
let Color = {
	White:0,
	Black:1,
	Clear:2,
};
let DrawMode = {
	Inverted:'exclusion',
	Copy:'source-over',
	Lighten:'lighten',
	Darken:'darken',
};

function ColorToFillStyle(color) {
	switch(color) {
	case Color.White:
		return 'rgb(255,255,255)';
		break;
	case Color.Black:
		return 'rgb(0,0,0)';
		break;
	default: // Color.Clear
		return 'rgba(0,0,0,0.0)';
		break;
	}
}

let canvas,context;
let totalAssets = 0; 
let Assets = { ready: function(){} };
function Bitmap(path) {
	let bitmap = this;
	
	// might be an image table
	let m = path.match(/-table-([0-9]+)-([0-9]+)/);
	this.cellWidth = m ? parseInt(m[1]) : 1;
	this.cellHeight = m ? parseInt(m[2]) : 1;
	this.cols = 1;
	this.rows = 1;

	let image = new Image;
	image.src = path;
	totalAssets += 1;
	image.onload = function() {
		// console.log('loaded',path);
		bitmap.cols = this.width / bitmap.cellWidth;
		bitmap.rows = this.height / bitmap.cellHeight;
		totalAssets -= 1;
		if (totalAssets==0) Assets.ready();
	};
	this.image = image;
	
	// for images
	this.draw = function(x,y) {
		context.drawImage(this.image,x,y);
	};

	// for imagetables
	this.drawImage = function(i,x,y) {
		let sy = Math.floor(i / this.cols);
		let sx = i - (this.cols * sy);
		sx *= this.cellWidth;
		sy *= this.cellHeight;
		context.drawImage(
			this.image,
			sx,sy,this.cellWidth,this.cellHeight, // src x,y,w,h
			x,y,this.cellWidth,this.cellHeight // dst x,y,w,h
		);
	};
}
function Textfile(path) {
	let textfile = this;

	let request = new XMLHttpRequest;
	request.open('GET', path);
	
	totalAssets += 1;
	request.addEventListener('load', function() {
		// console.log('loaded',path);
		textfile.text = this.responseText;
		if (textfile.ready) textfile.ready();
		totalAssets -= 1;
		if (totalAssets==0) Assets.ready();
	});
	request.send();
}
function Font(imagetablePath) {
	let font = this;

	let m = imagetablePath.match(/-table-([0-9]+)-([0-9]+)/);
	this.cellWidth = parseInt(m[1]);
	this.cellHeight = parseInt(m[2]);

	let fntPath = imagetablePath.replace(/-table-[0-9]+-[0-9]+\.png/,'.fnt');
	let bitmap = new Bitmap(imagetablePath);
	this.bitmap = bitmap;
	
	let fnt = new Textfile(fntPath);
	totalAssets += 1;
	font.chars = [];
	font.charWidths = {};
	fnt.ready = function() {
		let lines = fnt.text.split('\n');
		for (let i=0; i<lines.length; i++) {
			let pair = lines[i].split(/\s+/);
			if (pair.length<2) continue;
			let char = pair[0];
			if (char=='space') char = ' ';
			let width = parseInt(pair[1]);
			font.charWidths[char] = width;
			font.chars.push(char);
		}
		// console.log('parsed', fntPath);

		totalAssets -= 1;
		if (totalAssets==0) Assets.ready();
	}
	
	this.getTextWidth = function(text) {
		let width = 0;
		let chars = text.split('');
		for (let i=0; i<chars.length; i++) {
			let char = chars[i];
			width += this.charWidths[char];
			if (char=='\n') break; // doesn't support newline
		}
		return width;
	}
	this.drawText = function(text,x,y) {
		let ox = 0;
		let oy = 0;
		let chars = text.split('');
		for (let i=0; i<chars.length; i++) {
			let char = chars[i];
			let j = this.chars.indexOf(char);
			this.bitmap.drawImage(j,x+ox,y+oy);
			ox += this.charWidths[char];
			if (char=='\n') {
				ox = 0;
				oy += this.cellHeight;
			}
		}
	}
}

let scale = window.devicePixelRatio;
let screenWidth = 400;
let screenHeight = 240;
canvas = document.createElement('canvas');
canvas.width = screenWidth;
canvas.height = screenHeight;
context = canvas.getContext('2d');

context.fillStyle = ColorToFillStyle(Color.Black);
context.fillRect(0,0,screenWidth,screenHeight);

let iconCal = new Bitmap('assets/cal-table-16-14.png');
let fontBlack = new Font('assets/font-black-table-12-16.png');
let fontGray = new Font('assets/font-gray-table-12-16.png');

function render() {
	let PlaydateWhite = '#b1aea8';
	let PlaydateBlack = '#322f27';
	
	context.globalCompositeOperation = DrawMode.Darken;
		context.fillStyle = PlaydateWhite;
		context.fillRect(0,0,screenWidth,screenHeight);
	context.globalCompositeOperation = DrawMode.Lighten;
		context.fillStyle = PlaydateBlack;
		context.fillRect(0,0,screenWidth,screenHeight);
	context.globalCompositeOperation = DrawMode.Copy;
	
	let record = document.querySelector('#record i');
	let image = document.createElement('img');
	image.src = canvas.toDataURL();
	record.appendChild(image);
}

Assets.ready = function() {
	let m = location.search.match(/\?m([0-9])c([0-9])g([0-9])c([0-9])t([0-9])w([0-9]{4}-[0-9]{2}-[0-9]{2})s([0-9]+)c([0-9]+)n([0-9]+)t([0-9]{2}\:[0-9]{2})S([0-9]+)/);
	if (m) {
		console.log('detected');
		
		function luaInt(str) { 
			return parseInt(str)-1;
		}
		function checksum(str) {
			let checksum = 0;
			for (let i=0; i<str.length; i++) {
				checksum += str.charCodeAt(i) * (i+1);
			}
			return checksum;
		}

		let signed = m[11];
		let message = m[0].substring(0,m[0].length-signed.length-1);

		let M = checksum(message);
		let S = parseInt(signed);
	
		let a = 4486
		let b = 3364
		let p = 5050
		if (((a*M)%p)==((b*S)%p)) {
			console.log('valid');
			
			// v1
			let _mazes = ['RANDOM','DAILY'];
			let _crows = ['NOPE','SLOW','CASUAL','FAST'];
			let _goals = ['SCORE','NICES','CLOUDS','TIME'];
			let _clouds= ['100','200','400'];
			let _times = ['00:30','01:00','02:00','03:00','05:00'];
	
			let maze = _mazes[luaInt(m[1])];
			let crow = _crows[luaInt(m[2])];
			let goal = _goals[luaInt(m[3])];
			let goalClouds = _clouds[luaInt(m[4])];
			let goalTime = _times[luaInt(m[5])];
	
			let when = m[6];
			let score = m[7];
			let clouds = m[8];
			let nices = m[9];
			let time = m[10];

			// console.log(`maze: ${maze}`);
			// console.log(`crow: ${crow}`);
			// console.log(`goal: ${goal}`);
			// if (goal=='CLOUDS') console.log(`time: ${goalTime}`);
			// else if (goal=='TIME') console.log(`clouds: ${goalClouds}`);
			// console.log(`when: ${when}`);
			//
			// console.log(`score: ${score}`);
			// console.log(`clouds: ${clouds}`);
			// console.log(`nices: ${nices}`);
			// console.log(`time: ${time}`);
		
			let x = 110;
			let y = 16;
			
			fontGray.drawText('MAZE',x,y);
			fontBlack.drawText(maze,x+12*8,y);
			y += 16

			fontGray.drawText('CROW',x,y);
			fontBlack.drawText(crow,x+12*8,y);
			y += 16

			fontGray.drawText('GOAL',x,y);
			fontBlack.drawText(goal,x+12*8,y);
			y += 16
			
			if (goal=='CLOUDS') {
				fontGray.drawText('TIME',x,y);
				fontBlack.drawText(time,x+12*8,y);
				y += 16
			}
			else if (goal=='TIME') {

				fontGray.drawText('CLOUDS',x,y);
				fontBlack.drawText(clouds,x+12*8,y);
				y += 16
			}
			
			if (maze=='DAILY') {
				y = 112;
				context.fillStyle = ColorToFillStyle(Color.White);
				context.fillRect(0,y-2,screenWidth,18);

				context.globalCompositeOperation = DrawMode.Inverted;
				iconCal.drawImage(0,120,y);
				fontBlack.drawText(when,144,y);
				context.globalCompositeOperation = DrawMode.Copy;
			}
			
			x = 164;
			y = 144;
			fontBlack.drawText('RECORD',x,y);
			
			x = 96;
			y += 16;
			fontGray.drawText('SCORE',x,y);
			fontBlack.drawText(score.padStart(6),x,y+16);
			
			fontGray.drawText('CLOUDS',x+120,y);
			fontBlack.drawText(clouds.padStart(6),x+120,y+16);
			
			y += 32;
			fontGray.drawText('NICES',x,y);
			fontBlack.drawText(nices.padStart(6),x,y+16);
			
			fontGray.drawText('TIME',x+120,y);
			fontBlack.drawText(time.padStart(6),x+120,y+16);
			
			render();
			return;
		}
	}
	
	console.log('invalid');
	let error = 'INVALID RECORD'
	let width = fontBlack.getTextWidth(error);
	let x = (screenWidth-width)/2;
	let y = (screenHeight-16)/2;
	fontBlack.drawText(error,x,y);
	render();
};
</script>
</body>
</html>